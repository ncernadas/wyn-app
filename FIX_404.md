# Solución al Error 404 con BasePath

## El Problema

Al acceder a `http://10.0.100.212/wyn` o `http://localhost:3000/wyn`, la aplicación mostraba un **404 "This page could not be found"**.

## Causa Raíz

En Next.js 16 con `basePath` configurado, el **matcher del proxy debe incluir explícitamente la ruta raíz** (`'/'`) para que el middleware de next-intl funcione correctamente.

Sin esto, el proxy no intercepta las peticiones a la raíz del basePath y no puede hacer el redirect al locale por defecto.

## La Solución

### Cambios en `src/proxy.ts`

```diff
export const config = {
+  // Matcher is relative to basePath
  matcher: [
+    // Match root explicitly (important when using basePath)
+    '/',
    // Match all pathnames except for
    // - api routes
    // - _next (Next.js internals)
    // - _static (inside /public)
    // - files with extensions (e.g. favicon.ico)
    '/((?!api|_next|_static|.*\\..*).*)' ,
  ],
};
```

### Otros Cambios Realizados

1. **`localePrefix: 'always'`** - Cambiado de `'as-needed'` a `'always'` para que ambos locales (`/es` y `/en`) tengan prefijo explícito en la URL.

2. **LanguagePicker actualizado** - La lógica de cambio de idioma ahora maneja correctamente ambos prefijos.

## Cómo Funciona Ahora

### Flujo de Redirección

1. Usuario accede a `http://10.0.100.212/wyn`
2. Nginx hace proxy a `http://localhost:3003`
3. Next.js recibe la petición y elimina el basePath, quedando `/`
4. El proxy de next-intl intercepta `/` (gracias al matcher con `'/'`)
5. Redirige automáticamente con `307 Temporary Redirect` a `/es`
6. Next.js añade el basePath de vuelta: `/wyn/es`
7. La página se carga correctamente

### URLs Resultantes

```
✅ http://10.0.100.212/wyn     → Redirect a /wyn/es (automático)
✅ http://10.0.100.212/wyn/es  → Español (directo)
✅ http://10.0.100.212/wyn/en  → Inglés (directo)
```

## Verificación

Para verificar que todo funciona correctamente:

```bash
# 1. Desarrollo local con basePath
pnpm run dev:base

# 2. Probar redirección raíz
curl -I http://localhost:3000/wyn
# Debe devolver: HTTP/1.1 307 Temporary Redirect
#                location: /wyn/es

# 3. Probar página española
curl -I http://localhost:3000/wyn/es
# Debe devolver: HTTP/1.1 200 OK

# 4. Probar página inglesa
curl -I http://localhost:3000/wyn/en
# Debe devolver: HTTP/1.1 200 OK
```

## Deploy en Producción

```bash
# En la VM:
cd /var/www/wyn-app
git pull origin main
pnpm install
pnpm run build:deploy
cp -r public .next/standalone/public
cp -r .next/static .next/standalone/.next/static
pm2 restart wyn-app

# Verificar
curl -I http://localhost:3003
# Debe devolver 307 redirect a /es
```

## Archivos Modificados

1. `src/proxy.ts` - Añadido `'/'` al matcher
2. `src/proxy.ts` - Cambiado `localePrefix: 'always'`
3. `src/components/navbar/LanguagePicker.tsx` - Actualizada lógica de cambio de idioma

## Referencias

- [Next.js 16 - Proxy Documentation](https://nextjs.org/docs/app/api-reference/file-conventions/proxy)
- [next-intl - Middleware with basePath](https://next-intl.dev/docs/routing/middleware)
- [Renaming Middleware to Proxy](https://nextjs.org/docs/messages/middleware-to-proxy)
